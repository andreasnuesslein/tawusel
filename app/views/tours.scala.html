@(active_tours: List[Tour], tour_templates: List[Tour], avail_tours: List[Tour],towns:List[Town],locations: List[Location])(implicit request: RequestHeader)

@implicitFieldConstructor = @{ FieldConstructor(_formhelpers.f) }

@import helper._

@title = {
Plan a new tour
}
@main(title,nav="newtour") {
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/jquery.timepicker.css")">
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/bootstrap-datepicker.css")">
<script src="@routes.Assets.at("js/jquery.timepicker.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/bootstrap-datepicker.js")" type="text/javascript"></script>

<script src="@routes.Assets.at("js/tablefilter_all_min.js")" type="text/javascript"></script>

<script>
  function pad(num) {
    if (num < 10) {
      num = "0" + num;
    }
    return num;
  }
  function round_tr(hours,min) {
    var h = hours;
    var m;

    if (min>30){
      h = hours+1;
      m = 0;
      } else {
      m = 30;
    }
    return pad(h)+":"+pad(m);
  }

  function updateEstimate() {
    var txt = "Arr";
    if ($("#time-toggle").find('.active').text() == "Arr") {
      txt = "Dep";
    }
    var est = $("#timepicker").val();

    $("#time-estimate").text(txt+": "+est);
  };

  $(document).ready(function() {
    var now = new Date();
    var now_f = pad(now.getDate()) + "." + pad(now.getMonth()+1) + "." + now.getFullYear();
    $('.datepicker').val(now_f);
    $('.datepicker').datepicker({format:"dd.mm.yyyy"});

    now.setMinutes(now.getMinutes()+30);
    $('#timepicker').val(  round_tr(now.getHours(), now.getMinutes()) );
    $('#timepicker').timepicker({ 'scrollDefaultNow': true, 'timeFormat': "H:i" });

    $("#createForm").submit(function (){
      var d = $('#date').val().split(".");
      var t = $('#timepicker').val().split(":");

      var y = new Date(d[2],d[1]-1,d[0],t[0],t[1]);
      $('#date').val(y.getTime());
      $('#departure').val(y.getTime());
      $('#arrival').val(y.getTime());
    });

    var tf0 = setFilterGrid("tourlist",1,{
      on_keyup:true,
      on_keyup_delay:0,
      highlight_keywords: true,
      col_0:"select"});

    $('#city').change(function() {
      $('#dep_location').find('option').hide();
      $('#arr_location').find('option').hide();
      var delems = $('#dep_location').find('.town_'+this.value);
      delems.show();
      var aelems = $('#arr_location').find('.town_'+this.value);
      aelems.show();

      var first = delems[0].value;
      var snd = aelems[1].value;

      $('#dep_location').val(first);
      $('#arr_location').val(snd);
    });

    $("#arrbtn").click(function() {
      updateEstimate();
    });
    $("#depbtn").click(function() {
      updateEstimate();
    });

  });
</script>


<table cellpadding="0" cellspacing="0" border="0" class="table table-bordered"  id="tourlist">
  <caption>
  </caption>
  <thead>
    <tr>
      <th>City</th>
      <th>From</th>
      <th>To</th>
      <th>Time</th>
      <th>Passengers</th>
    </tr>
  </thead>
  <tbody>
    @active_tours.map { tour =>
    <tr class="tour_active">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }
    @tour_templates.map { tour =>
    <tr class="tour_template">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }

    @avail_tours.map { tour =>
    <tr class="tour">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }
  </tbody>
</table>
<div>green - Active Tours. blue - Templates. white - Booked Tours</div>

<div class="offset4 span2">
  <a class="btn btn-info" data-toggle="modal" href="#deleteModal" >Add tour</a>
</div>

<form name="createForm" id="createForm" class="form-horizontal" action="/newTour" method="POST">
  <div class="modal hide" id="deleteModal">

    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">Ã—</button>
      <h3>Create new tour</h3>
    </div>

    <div class="modal-body">
      <fieldset>
        <div class="control-group">
          <label class="control-label" for="city">City</label>
          <div class="controls">
            <select name="city" id="city">
              @towns.map { t =>
              <option value="@t.id">@t.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="dep_location">From</label>
          <div class="controls">
            <select name="dep_location" id="dep_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="arr_location">To</label>
          <div class="controls">
            <select name="arr_location" id="arr_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="date">Date</label>
          <div class="controls">
            <input type="text" id="date" class="datepicker" name="date" value/>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="timepicker">Time</label>
          <div class="controls">
            <input type="text" id="timepicker" name="timepicker" style="display:inline;width:4em;" />
            <div class="btn-group" data-toggle="buttons-radio" id="time-toggle" style="display:inline;">
              <div class="btn active" id="depbtn">Dep</div>
              <div class="btn" id="arrbtn">Arr</div>
            </div>
            <span class="help-inline"><span id="time-estimate"></span></span>
          </div>
        </div>
        <input type="hidden" id="departure" name="departure" />
        <input type="hidden" id="arrival" name="arrival" />
      </fieldset>

      <div><span style="color:red;">*</span>Legal mumbo jumbo... By hitting 'create tour' you agree .. yadda yadda yadda</div>

    </div>
    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">Close</a>
      <button type="submit" href="#" class="btn btn-primary" name="submit" id="submit">Create tour</button>
    </div>
  </div>
</form>

}

