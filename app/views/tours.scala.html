@(active_tours: List[Tour], tour_templates: List[Tour], avail_tours: List[Tour],towns:List[Town],locations: List[Location])(implicit request: RequestHeader)

@implicitFieldConstructor = @{ FieldConstructor(_formhelpers.f) }

@import helper._

@title = {
Plan a new tour
}
@main(title,nav="newtour") {
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/jquery.timepicker.css")">
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/bootstrap-datepicker.css")">
<script src="@routes.Assets.at("js/jquery.timepicker.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/bootstrap-datepicker.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/tablefilter_all_min.js")" type="text/javascript"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDbuLn6X-MuK9PnJtt7bF84PoPypXQN53U&sensor=true" type="text/javascript"></script>

<script>
  var googleest;
  var loca= new Array();
  @locations.map { l =>
      loca[@l.id]= "@l.address";
  }

  function getGoogleDistance() {
    var service = new google.maps.DistanceMatrixService();

    var depl = loca[$("#dep_location option:selected").val()];
    var arrl = loca[$("#arr_location option:selected").val()];

    service.getDistanceMatrix(
    {
      origins: [depl],
      destinations: [arrl],
      travelMode: google.maps.TravelMode.DRIVING,
      avoidHighways: false,
      avoidTolls: false
    }, distcallback);
  }

  function distcallback(response, status) {
    if (status == google.maps.DistanceMatrixStatus.OK) {
      googleest = response.rows[0].elements[0].duration.value;
      updateEstimate();
    }
    else {
      alert('problem');
    }
  }

  function pad(num) {
    if (num < 10) {
      num = "0" + num;
    }
    return num;
  }

  function round_tr(hours,min) {
    var h = hours;
    var m;

    if (min>30){
      h = hours+1;
      m = 0;
      } else {
      m = 30;
    }
    return pad(h)+":"+pad(m);
  }

  function updateEstimate() {
    var est = $("#timepicker").val().split(":");
    var d = $('#datepicker').val().split(".");

    var odate = new Date(d[2],d[1]-1,d[0],est[0],est[1]);
    var gdate = Math.ceil(googleest/60);
    $('#date').val(odate.getTime());

    var txt = "Arr";
    if ($("#time-toggle").find('.active').text() == "Arr") {
      txt = "Dep";
      $('#arrival').val(odate.getTime());
      odate.setMinutes(odate.getMinutes()-gdate);
      $('#departure').val(odate.getTime());
    } else {
      $('#departure').val(odate.getTime());
      odate.setMinutes(odate.getMinutes()+gdate);
      $('#arrival').val(odate.getTime());
    }

    $("#time-estimate").text(txt+": "+pad(odate.getHours())+":"+pad(odate.getMinutes()));
  }

  $(document).ready(function() {

    // initial filling of DIVs
    var now = new Date();
    var now_f = pad(now.getDate()) + "." + pad(now.getMonth()+1) + "." + now.getFullYear();
    $('.datepicker').val(now_f);
    $('.datepicker').datepicker({format:"dd.mm.yyyy"});
    now.setMinutes(now.getMinutes()+30);
    $('#timepicker').val(  round_tr(now.getHours(), now.getMinutes()) );
    $('#timepicker').timepicker({ 'scrollDefaultNow': true, 'timeFormat': "H:i" });
    setFilterGrid("tourlist",1,{
      on_keyup:true,
      on_keyup_delay:0,
      highlight_keywords: true,
      col_0:"select"
    });

    // change and click functions
    $('#city').change(function() {
      var valu = $('#city').val();
      $('#dep_location').find('option').hide();
      $('#arr_location').find('option').hide();
      var delems = $('#dep_location').find('.town_'+valu);
      delems.show();
      var aelems = $('#arr_location').find('.town_'+valu);
      aelems.show();

      var first = delems[0].value;
      var snd = aelems[1].value;

      $('#dep_location').val(first);
      $('#arr_location').val(snd);
      getGoogleDistance();
    });

    $("#dep_location").change(function() {getGoogleDistance(); });
    $("#arr_location").change(function() {getGoogleDistance(); });
    $("#arrbtn").click(function() {updateEstimate(); });
    $("#depbtn").click(function() {updateEstimate(); });
    $("#timepicker").change(function() {updateEstimate(); });

    $('#city').change();
  });

</script>


<table cellpadding="0" cellspacing="0" border="0" class="table table-bordered"  id="tourlist">
  <caption>
  </caption>
  <thead>
    <tr>
      <th>City</th>
      <th>From</th>
      <th>To</th>
      <th>Time</th>
      <th>Passengers</th>
    </tr>
  </thead>
  <tbody>
    @active_tours.map { tour =>
    <tr class="tour_active">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }
    @tour_templates.map { tour =>
    <tr class="tour_template">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }

    @avail_tours.map { tour =>
    <tr class="tour">
      <td>@tour.dep_location</td>
      <td>@tour.dep_location</td>
      <td>@tour.arr_location</td>
      <td>@tour.departure - @tour.arrival</td>
      <td>-</td>
    </tr>
    }
  </tbody>
</table>
<div>green - Active Tours. blue - Templates. white - Booked Tours</div>

<div class="offset4 span2">
  <a class="btn btn-info" data-toggle="modal" href="#deleteModal" >Add tour</a>
</div>

<form name="createForm" id="createForm" class="form-horizontal" action="/newTour" method="POST">
  <div class="modal hide" id="deleteModal">

    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">Ã—</button>
      <h3>Create new tour</h3>
    </div>

    <div class="modal-body">
      <fieldset>
        <div class="control-group">
          <label class="control-label" for="city">City</label>
          <div class="controls">
            <select name="city" id="city">
              @towns.map { t =>
              <option value="@t.id">@t.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="dep_location">From</label>
          <div class="controls">
            <select name="dep_location" id="dep_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="arr_location">To</label>
          <div class="controls">
            <select name="arr_location" id="arr_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="datepicker">Date</label>
          <div class="controls">
            <input type="text" id="datepicker" class="datepicker" name="datepicker" value/>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="timepicker">Time</label>
          <div class="controls">
            <input type="text" id="timepicker" name="timepicker" style="display:inline;width:4em;" />
            <div class="btn-group" data-toggle="buttons-radio" id="time-toggle" style="display:inline;">
              <div class="btn active" id="depbtn">Dep</div>
              <div class="btn" id="arrbtn">Arr</div>
            </div>
            <span class="help-inline"><span id="time-estimate"></span></span>
          </div>
        </div>
        <input type="hidden" id="departure" name="departure" />
        <input type="hidden" id="arrival" name="arrival" />
        <input type="hidden" id="date" name="date" />
      </fieldset>

    </div>
    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">Close</a>
      <button type="submit" href="#" class="btn btn-primary" name="submit" id="submit">Create tour</button>
    </div>
  </div>
</form>

}

