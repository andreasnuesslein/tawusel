@(active_tours: List[(Int, String, String, String, java.util.Date, java.util.Date, Int, List[(Int,String,String,String,String)], Int)],
  tour_templates: List[(String, String, String, java.util.Date, java.util.Date)],
  avail_tours: List[(Int, String, String, String, java.util.Date, java.util.Date, Int, List[(Int,String,String,String,String)], Int)],
towns:List[Town],locations: List[Location])(implicit request: RequestHeader)

@implicitFieldConstructor = @{ FieldConstructor(_formhelpers.f) }

@import helper._

@title = {
Plan a new tour
}
@main(title,nav="newtour") {
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/jquery.timepicker.css")">
<link rel="stylesheet" media="screen" href="@routes.Assets.at("css/bootstrap-datepicker.css")">
<script src="@routes.Assets.at("js/jquery.timepicker.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/bootstrap-datepicker.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/tablefilter_all_min.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/bootstrap-tooltip.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("js/bootstrap-popover.js")" type="text/javascript"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDbuLn6X-MuK9PnJtt7bF84PoPypXQN53U&sensor=true" type="text/javascript"></script>

<script>
  var googleest;
  var loca= new Array();
  @locations.map { l =>
      loca[@l.id]= "@l.address";
  }

  function getGoogleDistance() {
    var service = new google.maps.DistanceMatrixService();

    var depl = loca[$("#dep_location option:selected").val()];
    var arrl = loca[$("#arr_location option:selected").val()];

    service.getDistanceMatrix(
    {
      origins: [depl],
      destinations: [arrl],
      travelMode: google.maps.TravelMode.DRIVING,
      avoidHighways: false,
      avoidTolls: false
    }, distcallback);
  }

  function distcallback(response, status) {
    if (status == google.maps.DistanceMatrixStatus.OK) {
      googleest = response.rows[0].elements[0].duration.value;
      updateEstimate();
    }
    else {
      alert('problem');
    }
  }

  function pad(num) {
    if (num < 10) {
      num = "0" + num;
    }
    return num;
  }

  function round_tr(hours,min) {
    var h = hours;
    var m;

    if (min>30){
      h = hours+1;
      m = 0;
      } else {
      m = 30;
    }
    return pad(h)+":"+pad(m);
  }

  function updateEstimate() {
    var est = $("#timepicker").val().split(":");
    var d = $('#datepicker').val().split(".");

    var odate = new Date(d[2],d[1]-1,d[0],est[0],est[1]);
    var gdate = Math.ceil(googleest/60);
    $('#date').val(odate.getTime());

    var txt = "Arr";
    if ($("#time-toggle").find('.active').text() == "Arr") {
      txt = "Dep";
      $('#arrival').val(odate.getTime());
      odate.setMinutes(odate.getMinutes()-gdate);
      $('#departure').val(odate.getTime());
    } else {
      $('#departure').val(odate.getTime());
      odate.setMinutes(odate.getMinutes()+gdate);
      $('#arrival').val(odate.getTime());
    }

    $("#time-estimate").text(txt+": "+pad(odate.getHours())+":"+pad(odate.getMinutes()));
  }

  $(document).ready(function() {

    // initial filling of DIVs
    var now = new Date();
    var now_f = pad(now.getDate()) + "." + pad(now.getMonth()+1) + "." + now.getFullYear();
    $('.datepicker').val(now_f);
    $('.datepicker').datepicker({format:"dd.mm.yyyy"});
    now.setMinutes(now.getMinutes()+30);
    $('#timepicker').val(  round_tr(now.getHours(), now.getMinutes()) );
    $('#timepicker').timepicker({ 'scrollDefaultNow': true, 'timeFormat': "H:i" });
    setFilterGrid("tourlist",1,{
      on_keyup:true,
      on_keyup_delay:0,
      highlight_keywords: true,
      col_0:"select",
      col_5:"none",
      col_6:"none"
    });
    $(".modtime").each(function() {
      var elems = $(this).text().split(" - ");
      var se1 = elems[0].split(":");
      var se2 = elems[1].split(":");
      $(this).text(pad(se1[0])+":"+pad(se1[1])+" - "+pad(se2[0])+":"+pad(se2[1])  );
    });
    $('.passenger').popover({placement:"top"});
    $('.passenger').prepend(function(index,html) {
      return "<img src=\"http://www.gravatar.com/avatar/"+hex_md5($(this).attr('email'))+"?s=16\" />";
    });
    $('.statusicon').popover({placement:"top"});
    $('.legend').popover({placement:"bottom"});

    // change and click functions
    $('#city').change(function() {
      var valu = $('#city').val();
      $('#dep_location').find('option').hide();
      $('#arr_location').find('option').hide();
      var delems = $('#dep_location').find('.town_'+valu);
      delems.show();
      var aelems = $('#arr_location').find('.town_'+valu);
      aelems.show();

      var first = delems[0].value;
      var snd = aelems[1].value;

      $('#dep_location').val(first);
      $('#arr_location').val(snd);
      getGoogleDistance();
    });

    $("#dep_location").change(function() {getGoogleDistance(); });
    $("#arr_location").change(function() {getGoogleDistance(); });
    $("#arrbtn").click(function() {updateEstimate(); });
    $("#depbtn").click(function() {updateEstimate(); });
    $("#timepicker").change(function() {updateEstimate(); });

    $('#city').change();


    $(".tour_template a").click(function () {
      $("#dep_location option").attr("selected", false);
      $("#arr_location option").attr("selected", false);

      $('#createModal').modal('show');
      var row = $(this).parent().parent().children("td");
      $("#city option").filter(function () {
        return this.text == row[0].textContent;
      }).attr("selected", true);
      $('#city').change();
      $("#dep_location option[class=town_"+$('#city').val()+"]").filter(function () {
        return this.text == row[1].textContent;
      }).attr("selected", true);
      $("#arr_location option[class=town_"+$('#city').val()+"]").filter(function () {
        return this.text == row[2].textContent;
      }).attr("selected", true);

      var rowtime = row[3].textContent.split(" - ")[0]
      var now = new Date();
      if(now.getHours() > parseInt(rowtime.split(":")[0]) || ( now.getHours() == parseInt(rowtime.split(":")[0]) && now.getMinutes() >= parseInt(rowtime.split(":")[1])))
      {
        var now_f = pad(now.getDate()+1) + "." + pad(now.getMonth()+1) + "." + now.getFullYear();
        $("#datepicker").val(now_f);
      }
      $("#timepicker").val(rowtime);

      return false;

    });
  });

</script>
<style>
  .flt {
    width:auto;
    margin: -8px 0 -5px -5px;
  }
</style>
<div class="offset4 span2" style="margin-top:-50px">
  <a class="btn btn-info" data-toggle="modal" href="#createModal" >Add tour</a>
</div>

<div><span class="legend" rel="popover" data-content="These are the tours you are currently planning on participating in." data-original-title="My Tours"><div class="tour_active colour_box">     </div> - My Tours.</span> <span class="legend" rel="popover" data-content="These 5 tours are either predetermined templates to give some often used tours for fast creating. Or they are your personal favorites, determined by your previous tours, you are able to reset these in your profile settings." data-original-title="Favorite Tours"><div class="tour_template colour_box">     </div> - Favorite Tours.</span> <span class="legend" rel="popover" data-content="These are tours planned by other users. You are able to join these tours." data-original-title="Available Tours"><div class="colour_box">     </div> - Available Tours</span></div>

<table cellpadding="0" cellspacing="0" border="0" class="table table-bordered"  id="tourlist">
  <caption>
  </caption>
  <thead>
    <tr>
      <th>City</th>
      <th>From</th>
      <th>To</th>
      <th>Time</th>
      <th>Passengers</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    @active_tours.map { tour =>
    <tr class="tour_active">
      <td>@tour._2</td>
      <td>@tour._3</td>
      <td>@tour._4</td>
      <td><span class="modtime">@tour._5.getHours:@tour._5.getMinutes - @tour._6.getHours:@tour._6.getMinutes</span> (@tour._5.getDate.@(tour._5.getMonth + 1).@(tour._5.getYear + 1900))</td>
      <td>@tour._8.map { x =>
        @if(x._1 == tour._7) {
        <span class="mod" style="font-weight:bold;">
        } else {
        <span>
        }
        <span class="passenger" style="border-bottom: 1px black dotted;" rel="popover" data-content="Email: @x._2<br />Phone: @x._5" data-original-title="@x._3 @x._4" email="@x._2">@x._3</span> 
        </span>
        }
      </td>
      <td>
        <span class="status">@if(tour._9 == 1) {
          <span class="statusicon" rel="popover" data-content="This tour state is still pending. That means it has neither been confirmed nor cancelled yet." data-original-title="Pending"><a class="icon-question-sign"></a></span>
          }
          @if(tour._9 == 2) {
          <span class="statusicon" rel="popover" data-content="This tour has been confirmed." data-original-title="Booked"><a class="icon-ok"></a></span>
          }
          @if(tour._9 == 3) {
          <span class="statusicon" rel="popover" data-content="This tour has been cancelled. It will NOT take place." data-original-title="Cancelled"><a class="icon-warning-sign"></a></span>
          }
        </span>
      </td>
      <td>
        <a href="/tour/@tour._1/leave"><span class="btn btn-mini">leave</span></a></td>
    </tr>
    }
    @tour_templates.map { tour =>
    <tr class="tour_template">
      <td>@tour._1</td>
      <td>@tour._2</td>
      <td>@tour._3</td>
      <td class="modtime">@tour._4.getHours:@tour._4.getMinutes - @tour._5.getHours:@tour._5.getMinutes</td>
      <td>-</td>
      <td>-</td>
      <td><a href="" class="btn btn-mini">create</a></td>
    </tr>
    }

    @avail_tours.map { tour =>
    <tr class="tour">
      <td>@tour._2</td>
      <td>@tour._3</td>
      <td>@tour._4</td>
      <td><span class="modtime">@tour._5.getHours:@tour._5.getMinutes - @tour._6.getHours:@tour._6.getMinutes</span> (@tour._5.getDate.@(tour._5.getMonth + 1).@(tour._5.getYear + 1900))</td>
      <td>@tour._8.map { x =>
        @if(x._1 == tour._7) {
        <span class="mod" style="font-weight:bold;">
        } else {
        <span>
        }
        <span class="passenger" style="border-bottom: 1px black dotted;" rel="popover" data-content="Email: @x._2<br />Phone: @x._5" data-original-title="@x._3 @x._4" email="@x._2">@x._3</span>
        </span>
        }
      </td>
      <td>
        <span class="status">@if(tour._9 == 1) {
          <span class="statusicon" rel="popover" data-content="This tour state is still pending. That means a taxi has neither been confirmed nor cancelled yet." data-original-title="Pending"><a class="icon-question-sign"></a></span>
          }
          @if(tour._9 == 2) {
          <span class="statusicon" rel="popover" data-content="This tour has been confirmed, therefore a taxi will be waiting." data-original-title="Booked"><a class="icon-ok"></a></span>
          }
          @if(tour._9 == 3) {
          <span class="statusicon" rel="popover" data-content="This tour has been cancelled. Which means, a taxi has not been ordered, maybe another passenger than the initiator will call a taxi and confirm this. If that happens, the status will be changed." data-original-title="Cancelled"><a class="icon-warning-sign"></a></span>
          }
        </span>
      </td>
      <td><a href="/tour/@tour._1/join"><div class="btn btn-mini">join</div></a></td>
    </tr>
    }
  </tbody>
</table>

<form name="createForm" id="createForm" class="form-horizontal" action="/tours" method="POST">
  <div class="modal hide" id="createModal">

    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">×</button>
      <h3>Create new tour</h3>
    </div>

    <div class="modal-body">
      <fieldset>
        <div class="control-group">
          <label class="control-label" for="city">City</label>
          <div class="controls">
            <select name="city" id="city">
              @towns.map { t =>
              <option value="@t.id">@t.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="dep_location">From</label>
          <div class="controls">
            <select name="dep_location" id="dep_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="arr_location">To</label>
          <div class="controls">
            <select name="arr_location" id="arr_location">
              @locations.map { l =>
              <option value="@l.id" class="town_@l.town_id">@l.name</option>
              }
            </select>
            <span class="help-inline"></span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="datepicker">Date</label>
          <div class="controls">
            <input type="text" id="datepicker" class="datepicker" name="datepicker" value/>
            <span class="help-inline"></span>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="timepicker">Time</label>
          <div class="controls">
            <input type="text" id="timepicker" name="timepicker" style="display:inline;width:4em;" />
            <div class="btn-group" data-toggle="buttons-radio" id="time-toggle" style="display:inline;">
              <div class="btn active" id="depbtn">Dep</div>
              <div class="btn" id="arrbtn">Arr</div>
            </div>
            <span class="help-inline"><span id="time-estimate"></span></span>
          </div>
        </div>
        <input type="hidden" id="departure" name="departure" />
        <input type="hidden" id="arrival" name="arrival" />
        <input type="hidden" id="date" name="date" />
      </fieldset>

    </div>
    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">Close</a>
      <button type="submit" href="#" class="btn btn-primary" name="submit" id="submit">Create tour</button>
    </div>
  </div>
</form>

}

